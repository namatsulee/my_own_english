<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Grammar Quiz Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&family=Outfit:wght@300;400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: linear-gradient(180deg, #ffffff 0%, #f0f7f0 100%);
            min-height: 100vh;
            color: #2d3436;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px;
        }
        
        /* í™ˆ ë²„íŠ¼ */
        .home-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 18px;
            background: #ffffff;
            border: 2px solid #e8f5e9;
            border-radius: 30px;
            color: #00b894;
            font-weight: 600;
            font-size: 0.9rem;
            text-decoration: none;
            transition: all 0.3s ease;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0, 184, 148, 0.1);
        }
        
        .home-btn:hover {
            background: #00b894;
            color: #fff;
            border-color: #00b894;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 184, 148, 0.3);
        }
        
        .home-btn svg {
            width: 18px;
            height: 18px;
            fill: currentColor;
        }
        
        header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: #ffffff;
            border-radius: 20px;
            border: 2px solid #e8f5e9;
            box-shadow: 0 4px 20px rgba(0, 184, 148, 0.08);
        }
        
        h1 {
            font-family: 'Outfit', sans-serif;
            font-size: 2.5rem;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 10px;
        }
        
        h1 span {
            background: linear-gradient(135deg, #00b894, #00a085);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .subtitle {
            color: #636e72;
            font-size: 1rem;
        }
        
        .ai-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: linear-gradient(135deg, #00b894, #00a085);
            border-radius: 30px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-top: 12px;
            color: #fff;
            box-shadow: 0 4px 12px rgba(0, 184, 148, 0.25);
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 380px 1fr;
            gap: 30px;
        }
        
        .sidebar {
            background: #ffffff;
            border-radius: 20px;
            padding: 25px;
            border: 2px solid #e8f5e9;
            height: fit-content;
            position: sticky;
            top: 30px;
            box-shadow: 0 4px 15px rgba(0, 184, 148, 0.05);
        }
        
        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #00b894;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #1a1a1a;
        }
        
        .section-title::before {
            content: '';
            width: 8px;
            height: 8px;
            background: #00b894;
            border-radius: 50%;
        }
        
        /* API í‚¤ ì˜ì—­ */
        .api-section {
            margin-bottom: 20px;
            padding: 15px;
            background: #f0fff4;
            border-radius: 12px;
            border: 1px solid #d5f5e3;
        }
        
        .api-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: #2d3436;
        }
        
        .api-status.connected {
            color: #00b894;
        }
        
        .api-status.disconnected {
            color: #e74c3c;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #00b894;
            animation: pulse 2s infinite;
        }
        
        .status-dot.disconnected {
            background: #e74c3c;
            animation: none;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* íŒŒì¼ ì—…ë¡œë“œ ì˜ì—­ */
        .upload-area {
            border: 2px dashed #b8e6c9;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            margin-bottom: 25px;
            transition: all 0.3s ease;
            cursor: pointer;
            background: #f8fdf8;
        }
        
        .upload-area:hover {
            border-color: #00b894;
            background: #f0fff4;
            transform: translateY(-2px);
        }
        
        .upload-area.dragover {
            border-color: #f39c12;
            background: #fffbeb;
        }
        
        .upload-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }
        
        .upload-text {
            font-size: 0.95rem;
            color: #636e72;
        }
        
        .file-name {
            margin-top: 15px;
            padding: 10px 15px;
            background: #fffbeb;
            border-radius: 8px;
            font-size: 0.9rem;
            color: #f39c12;
            border: 1px solid #ffeaa7;
            display: none;
        }
        
        .file-name.show {
            display: block;
        }
        
        #fileInput {
            display: none;
        }
        
        /* ë³€í˜• ì˜µì…˜ */
        .option-group {
            margin-bottom: 25px;
        }
        
        .option-label {
            font-size: 0.9rem;
            color: #636e72;
            margin-bottom: 10px;
            display: block;
        }
        
        .level-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .level-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            background: #f8fdf8;
            border-radius: 12px;
            border: 2px solid #e8f5e9;
        }
        
        .level-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: #00b894;
            cursor: pointer;
        }
        
        .level-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            min-width: 35px;
            text-align: center;
        }
        
        .level-a { background: linear-gradient(135deg, #00b894, #00a085); color: #fff; }
        .level-b { background: linear-gradient(135deg, #f39c12, #e67e22); color: #fff; }
        .level-c { background: linear-gradient(135deg, #e74c3c, #c0392b); color: #fff; }
        
        .level-desc {
            flex: 1;
            font-size: 0.8rem;
            color: #636e72;
        }
        
        .level-count {
            width: 55px;
            padding: 8px;
            border: 2px solid #e8f5e9;
            border-radius: 8px;
            background: #ffffff;
            color: #2d3436;
            text-align: center;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        
        .level-count:focus {
            outline: none;
            border-color: #00b894;
            box-shadow: 0 0 0 3px rgba(0, 184, 148, 0.1);
        }
        
        /* ë²„íŠ¼ */
        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #00b894, #00a085);
            color: #fff;
            box-shadow: 0 4px 15px rgba(0, 184, 148, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 184, 148, 0.4);
        }
        
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: #fff;
            margin-top: 12px;
            box-shadow: 0 4px 15px rgba(243, 156, 18, 0.3);
        }
        
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(243, 156, 18, 0.4);
        }
        
        .btn-download {
            background: linear-gradient(135deg, #0984e3, #0770c7);
            color: #fff;
            margin-top: 12px;
            box-shadow: 0 4px 15px rgba(9, 132, 227, 0.3);
        }
        
        .btn-download:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(9, 132, 227, 0.4);
        }
        
        /* ê²°ê³¼ ì˜ì—­ */
        .result-area {
            background: #ffffff;
            border-radius: 20px;
            padding: 25px;
            border: 2px solid #e8f5e9;
            min-height: 500px;
            box-shadow: 0 4px 15px rgba(0, 184, 148, 0.05);
        }
        
        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .result-stats {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .stat-item {
            padding: 8px 16px;
            background: #f8fdf8;
            border-radius: 20px;
            font-size: 0.85rem;
            border: 1px solid #d5f5e3;
            color: #2d3436;
        }
        
        .stat-item span {
            color: #00b894;
            font-weight: 600;
        }
        
        /* ë¬¸ì œ ì¹´ë“œ */
        .question-list {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }
        
        .question-card {
            background: #f8fdf8;
            border-radius: 15px;
            padding: 25px;
            border: 2px solid #e8f5e9;
            transition: all 0.3s ease;
        }
        
        .question-card:hover {
            border-color: #00b894;
            box-shadow: 0 4px 20px rgba(0, 184, 148, 0.1);
        }
        
        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .question-number {
            font-family: 'Outfit', sans-serif;
            font-size: 1.2rem;
            font-weight: 600;
            color: #00b894;
        }
        
        .question-level {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .question-instruction {
            font-size: 0.9rem;
            color: #636e72;
            margin-bottom: 15px;
            padding: 12px 15px;
            background: #ffffff;
            border-radius: 10px;
            border-left: 3px solid #00b894;
        }
        
        .question-passage {
            font-size: 1rem;
            line-height: 1.8;
            margin-bottom: 20px;
            padding: 20px;
            background: #ffffff;
            border-radius: 10px;
            white-space: pre-wrap;
            border: 1px solid #e8f5e9;
            color: #2d3436;
        }
        
        .question-text {
            margin-bottom: 15px;
            padding: 12px 15px;
            background: #e8f8f5;
            border-radius: 10px;
            border-left: 3px solid #00b894;
            color: #2d3436;
        }
        
        .question-choices {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }
        
        .choice-item {
            padding: 12px 15px;
            background: #ffffff;
            border-radius: 10px;
            font-size: 0.9rem;
            border: 2px solid #f0f0f0;
            color: #2d3436;
        }
        
        .choice-number {
            font-weight: 600;
            color: #00b894;
            margin-right: 8px;
        }
        
        /* í•´ì„/í•´ì„¤ ì„¹ì…˜ */
        .explanation-section {
            margin-top: 20px;
            padding: 20px;
            background: #f5f0ff;
            border-radius: 12px;
            border: 1px solid #e0d4f7;
            display: none;
        }
        
        .explanation-section.show {
            display: block;
        }
        
        .explanation-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #9b59b6;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .explanation-content {
            font-size: 0.9rem;
            line-height: 1.7;
            color: #636e72;
        }
        
        .explanation-item {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0d4f7;
        }
        
        .explanation-item:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        
        .explanation-label {
            font-weight: 600;
            color: #0984e3;
            margin-bottom: 5px;
        }
        
        .answer-section {
            margin-top: 15px;
            padding: 12px 15px;
            background: #e8f8f5;
            border-radius: 10px;
            border: 1px solid #b8e6c9;
        }
        
        .answer-label {
            font-size: 0.9rem;
            color: #00b894;
            font-weight: 600;
        }
        
        /* ë¹ˆ ìƒíƒœ */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 400px;
            color: #b2bec3;
        }
        
        .empty-icon {
            font-size: 5rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .empty-text {
            font-size: 1.1rem;
            margin-bottom: 10px;
            color: #636e72;
        }
        
        .empty-subtext {
            font-size: 0.9rem;
            color: #b2bec3;
        }
        
        /* ë¡œë”© */
        .loading {
            display: none;
            text-align: center;
            padding: 50px;
        }
        
        .loading.show {
            display: block;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #d5f5e3;
            border-top-color: #00b894;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            color: #636e72;
            font-size: 0.95rem;
        }
        
        .loading-progress {
            margin-top: 15px;
            padding: 10px 20px;
            background: #fffbeb;
            border-radius: 8px;
            font-size: 0.85rem;
            color: #f39c12;
            border: 1px solid #ffeaa7;
        }
        
        /* íƒ­ */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 10px 20px;
            background: #f8fdf8;
            border: 2px solid #e8f5e9;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            color: #636e72;
        }
        
        .tab:hover {
            background: #e8f8f5;
            border-color: #b8e6c9;
        }
        
        .tab.active {
            background: linear-gradient(135deg, #00b894, #00a085);
            border-color: transparent;
            color: #fff;
        }
        
        /* ë°˜ì‘í˜• */
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                position: static;
            }
            
            .home-btn {
                position: relative;
                top: 0;
                left: 0;
                margin-bottom: 20px;
                width: fit-content;
            }
        }
        
        @media (max-width: 600px) {
            .container {
                padding: 15px;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .question-choices {
                grid-template-columns: 1fr;
            }
        }

        /* ì—‘ì…€ í˜•ì‹ ì•ˆë‚´ */
        .format-info {
            margin-top: 15px;
            padding: 15px;
            background: #fffbeb;
            border-radius: 10px;
            border: 1px solid #ffeaa7;
        }
        
        .format-info-title {
            font-size: 0.85rem;
            color: #f39c12;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .format-info-text {
            font-size: 0.75rem;
            color: #636e72;
            line-height: 1.6;
        }

        /* í† ìŠ¤íŠ¸ ë©”ì‹œì§€ */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 15px 25px;
            background: #ffffff;
            border-radius: 12px;
            color: #2d3436;
            font-size: 0.9rem;
            z-index: 1000;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }
        
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .toast.success {
            border-left: 4px solid #00b894;
        }
        
        .toast.error {
            border-left: 4px solid #e74c3c;
        }
        
        /* ìŠ¤í¬ë¡¤ë°” */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f0f7f0;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #b8e6c9;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #00b894;
        }
    </style>
</head>
<body>
    <a href="index.html" class="home-btn">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
        </svg>
        í™ˆìœ¼ë¡œ
    </a>
    
    <div class="container">
        <header>
            <h1>ğŸ¯ <span>Grammar</span> Quiz Generator</h1>
            <p class="subtitle">ì˜ì–´ ë¬¸ë²• ë³€í˜• ë¬¸ì œ ìë™ ì¶œì œ ì‹œìŠ¤í…œ</p>
            <span class="ai-badge">ğŸ¤– GPT-4o-mini ê¸°ë°˜</span>
        </header>
        
        <div class="main-content">
            <aside class="sidebar">
                <div class="api-section">
                    <div class="api-status" id="apiStatus">
                        <div class="status-dot disconnected"></div>
                        <span id="apiStatusText">API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”</span>
                    </div>
                    <div style="margin-top: 10px;">
                        <input type="password" id="apiKeyInput" placeholder="sk-..." 
                            style="width: 100%; padding: 12px 15px; border: 2px solid #e8f5e9; border-radius: 10px; background: #ffffff; color: #2d3436; font-size: 0.9rem;">
                        <button id="saveApiKey" style="width: 100%; margin-top: 10px; padding: 12px; background: linear-gradient(135deg, #00b894, #00a085); border: none; border-radius: 10px; color: #fff; font-weight: 600; cursor: pointer;">
                            ğŸ”‘ API í‚¤ ì €ì¥
                        </button>
                    </div>
                    <div style="margin-top: 10px; font-size: 0.75rem; color: #636e72;">
                        ğŸ’¡ API í‚¤ëŠ” ë¸Œë¼ìš°ì €ì—ë§Œ ì €ì¥ë˜ë©° ì„œë²„ë¡œ ì „ì†¡ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                    </div>
                </div>
                
                <div class="section-title">íŒŒì¼ ì—…ë¡œë“œ</div>
                
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">ğŸ“</div>
                    <div class="upload-text">ì—‘ì…€ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜<br>í´ë¦­í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”</div>
                    <input type="file" id="fileInput" accept=".xlsx,.xls">
                    <div class="file-name" id="fileName"></div>
                </div>
                
                <div class="format-info">
                    <div class="format-info-title">ğŸ“‹ ì—‘ì…€ í˜•ì‹</div>
                    <div class="format-info-text">
                        ì§€ì‹œë¬¸ | ë¬¸ì œ | ì„ ì§€1 | ì„ ì§€2 | ì„ ì§€3 | ì„ ì§€4 | ì„ ì§€5 | ì •ë‹µ
                    </div>
                </div>
                
                <div class="option-group" style="margin-top: 25px;">
                    <div class="section-title">ë³€í˜• ë ˆë²¨ë³„ ë¬¸í•­ ìˆ˜</div>
                    <div class="data-info" id="dataInfo" style="margin-bottom: 15px; padding: 12px; background: #e8f4fc; border-radius: 10px; font-size: 0.85rem; display: none; border: 1px solid #d4edfa;">
                        <span style="color: #0984e3; font-weight: 500;">ğŸ“Š ì—…ë¡œë“œëœ ë¬¸í•­:</span> <span id="dataCount" style="color: #0984e3; font-weight: 600;">0</span>ê°œ
                    </div>
                    <div class="level-options">
                        <div class="level-item">
                            <span class="level-badge level-a">A</span>
                            <span class="level-desc">ì„ ì§€ ìˆœì„œë§Œ ë³€ê²½</span>
                            <input type="number" class="level-count" id="countA" value="0" min="0" max="999" placeholder="0">
                            <span style="font-size: 0.8rem; color: #888;">ê°œ</span>
                        </div>
                        <div class="level-item">
                            <span class="level-badge level-b">B</span>
                            <span class="level-desc">ì¼ë¶€ í‘œí˜„ ë³€í˜•</span>
                            <input type="number" class="level-count" id="countB" value="0" min="0" max="999" placeholder="0">
                            <span style="font-size: 0.8rem; color: #888;">ê°œ</span>
                        </div>
                    </div>
                    <div class="total-info" style="margin-top: 15px; padding: 12px; background: #e8f8f5; border-radius: 10px; border: 1px solid #b8e6c9;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 0.9rem; color: #2d3436;">ìš”ì²­ ë¬¸í•­ í•©ê³„:</span>
                            <span id="totalRequest" style="font-size: 1.1rem; font-weight: 600; color: #00b894;">0ê°œ</span>
                        </div>
                        <div id="validationMsg" style="margin-top: 8px; font-size: 0.8rem; color: #e74c3c; display: none;"></div>
                    </div>
                </div>
                
                <button class="btn btn-primary" id="generateBtn" disabled>
                    âœ¨ AI ë³€í˜• ë¬¸ì œ ìƒì„±
                </button>
                
                <button class="btn btn-secondary" id="explanationBtn" style="display: none;">
                    ğŸ“š í•´ì„/í•´ì„¤/ì¶œì œì˜ë„ ìƒì„±
                </button>
                
                <button class="btn btn-download" id="downloadBtn" style="display: none;">
                    ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
                </button>
            </aside>
            
            <main class="result-area">
                <div class="result-header">
                    <div class="section-title">ìƒì„±ëœ ë¬¸ì œ</div>
                    <div class="result-stats" id="resultStats" style="display: none;">
                        <div class="stat-item">ì´ <span id="totalCount">0</span>ë¬¸ì œ</div>
                        <div class="stat-item">A: <span id="aCount">0</span></div>
                        <div class="stat-item">B: <span id="bCount">0</span></div>
                    </div>
                </div>
                
                <div class="tabs" id="tabsContainer" style="display: none;">
                    <div class="tab active" data-tab="questions">ë¬¸ì œì§€</div>
                    <div class="tab" data-tab="answers">ì •ë‹µì§€</div>
                </div>
                
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p class="loading-text">AIê°€ ë¬¸ì œë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
                    <p class="loading-progress" id="loadingProgress">ì¤€ë¹„ ì¤‘...</p>
                </div>
                
                <div class="empty-state" id="emptyState">
                    <div class="empty-icon">ğŸ“</div>
                    <div class="empty-text">ì•„ì§ ìƒì„±ëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤</div>
                    <div class="empty-subtext">ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê³  ìƒì„± ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”</div>
                </div>
                
                <div class="question-list" id="questionList" style="display: none;"></div>
                <div class="question-list" id="answerList" style="display: none;"></div>
            </main>
        </div>
    </div>
    
    <div class="toast" id="toast"></div>

    <script>
        // OpenAI API ì„¤ì •
        let OPENAI_API_KEY = localStorage.getItem('openai_api_key') || '';
        
        // ì „ì—­ ë³€ìˆ˜
        let originalData = [];
        let generatedQuestions = [];
        let currentTab = 'questions';

        // DOM ìš”ì†Œ
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileName = document.getElementById('fileName');
        const generateBtn = document.getElementById('generateBtn');
        const explanationBtn = document.getElementById('explanationBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const loading = document.getElementById('loading');
        const loadingProgress = document.getElementById('loadingProgress');
        const emptyState = document.getElementById('emptyState');
        const questionList = document.getElementById('questionList');
        const answerList = document.getElementById('answerList');
        const resultStats = document.getElementById('resultStats');
        const tabsContainer = document.getElementById('tabsContainer');

        // í† ìŠ¤íŠ¸ ë©”ì‹œì§€
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // API í‚¤ ê´€ë ¨ ê¸°ëŠ¥
        function updateApiStatus() {
            const statusDot = document.querySelector('.status-dot');
            const statusText = document.getElementById('apiStatusText');
            const apiInput = document.getElementById('apiKeyInput');
            
            if (OPENAI_API_KEY && OPENAI_API_KEY.startsWith('sk-')) {
                statusDot.classList.remove('disconnected');
                statusText.textContent = 'API ì—°ê²°ë¨ âœ“';
                apiInput.value = OPENAI_API_KEY.slice(0, 10) + '...' + OPENAI_API_KEY.slice(-4);
                apiInput.disabled = true;
                document.getElementById('saveApiKey').textContent = 'ğŸ—‘ï¸ API í‚¤ ì‚­ì œ';
            } else {
                statusDot.classList.add('disconnected');
                statusText.textContent = 'API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”';
                apiInput.value = '';
                apiInput.disabled = false;
                document.getElementById('saveApiKey').textContent = 'ğŸ”‘ API í‚¤ ì €ì¥';
            }
        }

        document.getElementById('saveApiKey').addEventListener('click', () => {
            const apiInput = document.getElementById('apiKeyInput');
            
            if (OPENAI_API_KEY && OPENAI_API_KEY.startsWith('sk-')) {
                // ì‚­ì œ ëª¨ë“œ
                localStorage.removeItem('openai_api_key');
                OPENAI_API_KEY = '';
                showToast('API í‚¤ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            } else {
                // ì €ì¥ ëª¨ë“œ
                const key = apiInput.value.trim();
                if (!key.startsWith('sk-')) {
                    showToast('ì˜¬ë°”ë¥¸ API í‚¤ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤. (sk-...)', 'error');
                    return;
                }
                localStorage.setItem('openai_api_key', key);
                OPENAI_API_KEY = key;
                showToast('API í‚¤ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            }
            updateApiStatus();
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ API ìƒíƒœ í™•ì¸
        updateApiStatus();

        // ë¬¸í•­ ìˆ˜ ê²€ì¦
        function updateValidation() {
            const countA = parseInt(document.getElementById('countA').value) || 0;
            const countB = parseInt(document.getElementById('countB').value) || 0;
            const total = countA + countB;
            const dataCount = originalData.length;
            
            document.getElementById('totalRequest').textContent = `${total}ê°œ`;
            
            const validationMsg = document.getElementById('validationMsg');
            
            if (dataCount === 0) {
                validationMsg.style.display = 'none';
                generateBtn.disabled = true;
            } else if (total === 0) {
                validationMsg.style.display = 'block';
                validationMsg.style.color = '#e74c3c';
                validationMsg.textContent = 'âš ï¸ ìµœì†Œ 1ê°œ ì´ìƒì˜ ë¬¸í•­ì„ ìš”ì²­í•´ì£¼ì„¸ìš”.';
                generateBtn.disabled = true;
            } else if (total !== dataCount) {
                validationMsg.style.display = 'block';
                validationMsg.style.color = '#e74c3c';
                validationMsg.textContent = `âš ï¸ ìš”ì²­ ë¬¸í•­(${total}ê°œ)ê³¼ ë°ì´í„°(${dataCount}ê°œ)ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.`;
                generateBtn.disabled = true;
            } else {
                validationMsg.style.display = 'block';
                validationMsg.style.color = '#00b894';
                validationMsg.textContent = `âœ“ ë°ì´í„° ${dataCount}ê°œì™€ ì¼ì¹˜í•©ë‹ˆë‹¤.`;
                generateBtn.disabled = false;
            }
        }

        // ë¬¸í•­ ìˆ˜ ì…ë ¥ ì´ë²¤íŠ¸
        document.getElementById('countA').addEventListener('input', updateValidation);
        document.getElementById('countB').addEventListener('input', updateValidation);

        // íŒŒì¼ ì—…ë¡œë“œ ì´ë²¤íŠ¸
        uploadArea.addEventListener('click', () => fileInput.click());
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) handleFile(file);
        });
        
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) handleFile(file);
        });

        // íŒŒì¼ ì²˜ë¦¬
        function handleFile(file) {
            if (!file.name.match(/\.(xlsx|xls)$/)) {
                showToast('ì—‘ì…€ íŒŒì¼(.xlsx, .xls)ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.', 'error');
                return;
            }
            
            fileName.textContent = `ğŸ“„ ${file.name}`;
            fileName.classList.add('show');
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const sheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                    
                    // ì²« ë²ˆì§¸ í–‰ì´ í—¤ë”ì¸ ê²½ìš° ì œì™¸
                    originalData = jsonData.slice(1).filter(row => row.length >= 8);
                    
                    if (originalData.length === 0) {
                        showToast('ìœ íš¨í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì—‘ì…€ í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.', 'error');
                        return;
                    }
                    
                    // ë°ì´í„° ê°œìˆ˜ í‘œì‹œ
                    document.getElementById('dataInfo').style.display = 'block';
                    document.getElementById('dataCount').textContent = originalData.length;
                    
                    // ì…ë ¥ í•„ë“œ max ê°’ ì„¤ì •
                    document.getElementById('countA').max = originalData.length;
                    document.getElementById('countB').max = originalData.length;
                    document.getElementById('countC').max = originalData.length;
                    
                    updateValidation();
                    generateBtn.disabled = false;
                    showToast(`${originalData.length}ê°œì˜ ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`, 'success');
                } catch (error) {
                    showToast('íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                    console.error(error);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // OpenAI API í˜¸ì¶œ
        async function callOpenAI(prompt, systemPrompt = '') {
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${OPENAI_API_KEY}`
                },
                body: JSON.stringify({
                    model: 'gpt-4o-mini',
                    messages: [
                        { role: 'system', content: systemPrompt || 'You are a helpful assistant for creating English test questions.' },
                        { role: 'user', content: prompt }
                    ],
                    temperature: 0.7,
                    max_tokens: 2000
                })
            });
            
            if (!response.ok) {
                throw new Error(`API ì˜¤ë¥˜: ${response.status}`);
            }
            
            const data = await response.json();
            return data.choices[0].message.content;
        }

        // AI ë³€í˜• ë¬¸ì œ ìƒì„±
        generateBtn.addEventListener('click', generateQuestions);

        async function generateQuestions() {
            const countA = parseInt(document.getElementById('countA').value) || 0;
            const countB = parseInt(document.getElementById('countB').value) || 0;
            const totalRequest = countA + countB;
            
            // API í‚¤ ì²´í¬ (Bìœ í˜•ì´ ìˆëŠ” ê²½ìš°)
            if (countB > 0 && (!OPENAI_API_KEY || !OPENAI_API_KEY.startsWith('sk-'))) {
                showToast('Bìœ í˜• ìƒì„±ì„ ìœ„í•´ OpenAI API í‚¤ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            if (totalRequest === 0) {
                showToast('ìµœì†Œ 1ê°œ ì´ìƒì˜ ë¬¸í•­ì„ ìš”ì²­í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            if (totalRequest !== originalData.length) {
                showToast(`ìš”ì²­ ë¬¸í•­(${totalRequest}ê°œ)ê³¼ ë°ì´í„°(${originalData.length}ê°œ)ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.`, 'error');
                return;
            }
            
            // ë¡œë”© í‘œì‹œ
            loading.classList.add('show');
            emptyState.style.display = 'none';
            questionList.style.display = 'none';
            answerList.style.display = 'none';
            generateBtn.disabled = true;
            
            generatedQuestions = [];
            let questionNum = 1;
            
            // ì›ë³¸ ë°ì´í„°ë¥¼ ì„ì–´ì„œ ë¶„ë°°
            const shuffledIndices = [...Array(originalData.length).keys()].sort(() => Math.random() - 0.5);
            
            // ê° ìœ í˜•ì— í• ë‹¹í•  ì¸ë±ìŠ¤ ë¶„ë°°
            const aIndices = shuffledIndices.slice(0, countA);
            const bIndices = shuffledIndices.slice(countA, countA + countB);
            
            try {
                // A ìœ í˜• ìƒì„±
                for (let i = 0; i < aIndices.length; i++) {
                    const idx = aIndices[i];
                    const row = originalData[idx];
                    const instruction = row[0] || '';
                    const question = row[1] || '';
                    const choices = [row[2], row[3], row[4], row[5], row[6]].filter(c => c);
                    const answer = row[7] || '';
                    
                    loadingProgress.textContent = `Aìœ í˜• ${i + 1}/${countA} ìƒì„± ì¤‘...`;
                    
                    const shuffledChoices = shuffleArray([...choices]);
                    const newAnswer = findNewAnswer(choices, shuffledChoices, answer);
                    
                    generatedQuestions.push({
                        num: questionNum++,
                        level: 'A',
                        instruction,
                        question,
                        choices: shuffledChoices,
                        answer: newAnswer,
                        originalQuestion: question,
                        originalChoices: [...choices],
                        originalAnswer: answer,
                        explanation: null
                    });
                }
                
                // B ìœ í˜• ìƒì„±
                for (let i = 0; i < bIndices.length; i++) {
                    const idx = bIndices[i];
                    const row = originalData[idx];
                    const instruction = row[0] || '';
                    const question = row[1] || '';
                    const choices = [row[2], row[3], row[4], row[5], row[6]].filter(c => c);
                    const answer = row[7] || '';
                    
                    loadingProgress.textContent = `Bìœ í˜• ${i + 1}/${countB} ìƒì„± ì¤‘... (AI ì²˜ë¦¬ ì¤‘)`;
                    
                    const transformed = await transformWithAI(question, choices, answer);
                    const finalAnswer = transformed.correctAnswer ? transformed.correctAnswer.toString() : answer;
                    
                    generatedQuestions.push({
                        num: questionNum++,
                        level: 'B',
                        instruction,
                        question: transformed.question,
                        choices: transformed.choices,
                        answer: finalAnswer,
                        originalQuestion: question,
                        originalChoices: choices,
                        originalAnswer: answer,
                        changes: transformed.changes,
                        explanation: null
                    });
                }
                
                
                // ê²°ê³¼ í‘œì‹œ
                loading.classList.remove('show');
                displayResults();
                showToast(`${generatedQuestions.length}ê°œì˜ ë³€í˜• ë¬¸ì œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!`, 'success');
                
            } catch (error) {
                loading.classList.remove('show');
                emptyState.style.display = 'flex';
                showToast(`ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, 'error');
                console.error(error);
            } finally {
                generateBtn.disabled = false;
            }
        }

        // AIë¡œ ë¬¸ì œ ë³€í˜• (Bìœ í˜•)
        async function transformWithAI(question, choices, originalAnswer = '') {
            // ì„ ì§€ë“¤ì˜ ì´ ë‹¨ì–´ ìˆ˜ë¡œ ë³€ê²½ëŸ‰ ê³„ì‚°
            const totalText = choices.join(' ');
            const wordCount = totalText.split(/\s+/).length;
            const minChanges = Math.max(2, Math.floor(wordCount / 3)); // ìµœì†Œ 2ë‹¨ì–´, 3ë‹¨ì–´ë‹¹ 1ê°œ ë³€ê²½
            
            const levelDesc = `Bìœ í˜• ë³€í˜• ê·œì¹™ (ë°˜ë“œì‹œ ì¤€ìˆ˜):
1. ìµœì†Œ ${minChanges}ê°œ ì´ìƒì˜ ë‹¨ì–´/í‘œí˜„ì„ ë³€ê²½í•´ì•¼ í•¨
2. ë¬¸ì¥ êµ¬ì¡°ëŠ” ë™ì¼í•˜ê²Œ ìœ ì§€í•˜ë˜, ë‹¨ì–´ëŠ” ì™„ì „íˆ ë‹¤ë¥¸ ë‹¨ì–´ë¡œ êµì²´ ê°€ëŠ¥
   - ì˜ˆì‹œ: "I don't like music" â†’ "We don't eat pizza" (êµ¬ì¡° ë™ì¼, ë‹¨ì–´ë§Œ ë³€ê²½)
3. ë°˜ë“œì‹œ ë¹„ìŠ·í•œ ë‚œì´ë„ì˜ ë‹¨ì–´ë¡œ êµì²´í•  ê²ƒ
   - buy â†’ get (O), buy â†’ purchase (X, ë‚œì´ë„ ì°¨ì´)
   - happy â†’ glad (O), happy â†’ elated (X, ë‚œì´ë„ ì°¨ì´)
4. ìœ ì˜ì–´ê°€ ì•„ë‹ˆì–´ë„ ë¨. ë¬¸ì¥ êµ¬ì¡°ë§Œ ê°™ìœ¼ë©´ ì™„ì „íˆ ë‹¤ë¥¸ ì˜ë¯¸ì˜ ë‹¨ì–´ë„ ê°€ëŠ¥
5. ë¬¸ë²•ì  ì •í™•ì„± ìœ ì§€
6. ë¬¸ì œ(ì§ˆë¬¸)ê°€ ìˆë‹¤ë©´ ë¬¸ì œë„ ì ì ˆíˆ ë³€í˜•`;
            
            const prompt = `ë‹¤ìŒ ì˜ì–´ ë¬¸ë²• ë¬¸ì œë¥¼ ë³€í˜•í•´ì£¼ì„¸ìš”.

[ë³€í˜• ê·œì¹™]:
${levelDesc}

[ì›ë³¸ ë¬¸ì œ]:
${question || '(ë¬¸ì œ ì—†ìŒ - ì„ ì§€ë§Œ ë³€í˜•)'}

[ì›ë³¸ ì„ ì§€]:
1. ${choices[0] || ''}
2. ${choices[1] || ''}
3. ${choices[2] || ''}
4. ${choices[3] || ''}
5. ${choices[4] || ''}

[ì›ë³¸ ì •ë‹µ]: ${originalAnswer}ë²ˆ

ì¤‘ìš”: 
- ëª¨ë“  ì„ ì§€ì˜ ë¬¸ì¥ êµ¬ì¡°ëŠ” ìœ ì§€í•˜ë˜, ë‹¨ì–´ë“¤ì„ ë³€í˜•í•˜ì„¸ìš”.
- ì •ë‹µ ì„ ì§€ì˜ ë‚´ìš©ë„ ë³€í˜•í•˜ë˜, ì •ë‹µì˜ ìœ„ì¹˜(ë²ˆí˜¸)ëŠ” ì›ë³¸ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€í•˜ì„¸ìš”.

ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•´ì£¼ì„¸ìš” (ë‹¤ë¥¸ í…ìŠ¤íŠ¸ ì—†ì´):
{
    "question": "ë³€í˜•ëœ ë¬¸ì œ (ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´)",
    "choices": ["ì„ ì§€1", "ì„ ì§€2", "ì„ ì§€3", "ì„ ì§€4", "ì„ ì§€5"],
    "changes": "ë³€ê²½ëœ ë‹¨ì–´/í‘œí˜„ ëª©ë¡ (ì˜ˆ: likeâ†’eat, musicâ†’pizza)",
    "correctAnswer": ì •ë‹µë²ˆí˜¸(ìˆ«ì, 1-5)
}`;

            const response = await callOpenAI(prompt);
            
            try {
                // JSON íŒŒì‹± ì‹œë„
                const jsonMatch = response.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    const parsed = JSON.parse(jsonMatch[0]);
                    return {
                        question: parsed.question || question,
                        choices: parsed.choices || choices,
                        changes: parsed.changes || '',
                        correctAnswer: parsed.correctAnswer || null
                    };
                }
            } catch (e) {
                console.error('JSON íŒŒì‹± ì˜¤ë¥˜:', e);
            }
            
            // íŒŒì‹± ì‹¤íŒ¨ ì‹œ ì›ë³¸ ë°˜í™˜
            return { question, choices, changes: 'ë³€í˜• ì‹¤íŒ¨', correctAnswer: null };
        }

        // í•´ì„/í•´ì„¤/ì¶œì œì˜ë„ ìƒì„±
        explanationBtn.addEventListener('click', generateExplanations);

        async function generateExplanations() {
            // API í‚¤ ì²´í¬
            if (!OPENAI_API_KEY || !OPENAI_API_KEY.startsWith('sk-')) {
                showToast('í•´ì„/í•´ì„¤ ìƒì„±ì„ ìœ„í•´ OpenAI API í‚¤ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            loading.classList.add('show');
            loadingProgress.textContent = 'í•´ì„/í•´ì„¤/ì¶œì œì˜ë„ ìƒì„± ì¤‘...';
            explanationBtn.disabled = true;
            
            try {
                for (let i = 0; i < generatedQuestions.length; i++) {
                    const q = generatedQuestions[i];
                    
                    if (q.explanation) continue; // ì´ë¯¸ ìƒì„±ëœ ê²½ìš° ìŠ¤í‚µ
                    
                    loadingProgress.textContent = `í•´ì„/í•´ì„¤ ìƒì„± ì¤‘... (${i + 1}/${generatedQuestions.length})`;
                    
                    const isObjective = q.choices && q.choices.length > 0;
                    const intentEnding = isObjective 
                        ? '~ì„/ë¥¼ ì•Œê³  ìˆë‹¤" ë˜ëŠ” "~ì„/ë¥¼ íŒŒì•…í•˜ê³  ìˆë‹¤"' 
                        : '~ì„/ë¥¼ ì“¸ ìˆ˜ ìˆë‹¤"';
                    
                    const prompt = `ë‹¤ìŒ ì˜ì–´ ë¬¸ì œì— ëŒ€í•œ í•´ì„, í•´ì„¤, ì¶œì œì˜ë„ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.

[ì§€ë¬¸]:
${q.passage}

[ë¬¸ì œ]:
${q.question}

[ì„ ì§€]:
${q.choices.map((c, i) => `${i + 1}. ${c}`).join('\n')}

[ì •ë‹µ]: ${q.answer}

ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•´ì£¼ì„¸ìš”:
{
    "translation": "ì§€ë¬¸ì˜ í•œêµ­ì–´ í•´ì„",
    "explanation": "ë¬¸ì œ í•´ì„¤ (ì™œ ì •ë‹µì´ ì •ë‹µì¸ì§€, ì˜¤ë‹µì´ ì™œ í‹€ë¦°ì§€ ì„¤ëª…)",
    "intent": "ì¶œì œì˜ë„ (${intentEnding}ë¡œ ëë‚˜ì•¼ í•¨)"
}`;

                    const response = await callOpenAI(prompt);
                    
                    try {
                        const jsonMatch = response.match(/\{[\s\S]*\}/);
                        if (jsonMatch) {
                            const parsed = JSON.parse(jsonMatch[0]);
                            q.explanation = {
                                translation: parsed.translation || '',
                                explanation: parsed.explanation || '',
                                intent: parsed.intent || ''
                            };
                        }
                    } catch (e) {
                        console.error('JSON íŒŒì‹± ì˜¤ë¥˜:', e);
                        q.explanation = {
                            translation: 'í•´ì„ ìƒì„± ì‹¤íŒ¨',
                            explanation: 'í•´ì„¤ ìƒì„± ì‹¤íŒ¨',
                            intent: 'ì¶œì œì˜ë„ ìƒì„± ì‹¤íŒ¨'
                        };
                    }
                }
                
                loading.classList.remove('show');
                displayResults();
                showToast('í•´ì„/í•´ì„¤/ì¶œì œì˜ë„ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                
            } catch (error) {
                loading.classList.remove('show');
                showToast(`ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, 'error');
                console.error(error);
            } finally {
                explanationBtn.disabled = false;
            }
        }

        // ë°°ì—´ ì„ê¸°
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // ìƒˆë¡œìš´ ì •ë‹µ ìœ„ì¹˜ ì°¾ê¸°
        function findNewAnswer(originalChoices, shuffledChoices, originalAnswer) {
            // ì •ë‹µì´ ìˆ«ìì¸ ê²½ìš° (1, 2, 3, 4, 5)
            const answerIndex = parseInt(originalAnswer) - 1;
            if (!isNaN(answerIndex) && answerIndex >= 0 && answerIndex < originalChoices.length) {
                const correctChoice = originalChoices[answerIndex];
                const newIndex = shuffledChoices.findIndex(c => c === correctChoice);
                return (newIndex + 1).toString();
            }
            return originalAnswer;
        }

        // ê²°ê³¼ í‘œì‹œ
        function displayResults() {
            questionList.innerHTML = '';
            answerList.innerHTML = '';
            
            const counts = { A: 0, B: 0 };
            
            generatedQuestions.forEach(q => {
                counts[q.level]++;
                
                // ë ˆë²¨ ì„¤ëª…
                let levelDescription = '';
                if (q.level === 'A') {
                    levelDescription = '<span style="color: #00b894; font-size: 0.85rem; font-weight: 500;">ğŸ“Œ ì›ë³¸ (ì„ ì§€ ìˆœì„œë§Œ ë³€ê²½)</span>';
                } else if (q.level === 'B') {
                    levelDescription = '<span style="color: #f39c12; font-size: 0.85rem; font-weight: 500;">ğŸ“Œ ì¼ë¶€ í‘œí˜„ ë³€í˜•</span>';
                }
                
                // ë¬¸ì œ ì¹´ë“œ
                const questionCard = document.createElement('div');
                questionCard.className = 'question-card';
                
                // Bìœ í˜•: ì›ë³¸ê³¼ ë³€í˜•ë³¸ ë¹„êµ í‘œì‹œ
                let comparisonSection = '';
                if (q.level === 'B') {
                    // ë¬¸ì œ ë¹„êµ (ë¬¸ì œê°€ ìˆëŠ” ê²½ìš°)
                    let questionComparison = '';
                    if (q.originalQuestion || q.question) {
                        questionComparison = `
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <div style="padding: 12px 15px; background: #f8f9fa; border-radius: 10px; border-left: 3px solid #b2bec3;">
                                    <div style="font-size: 0.8rem; color: #b2bec3; margin-bottom: 5px; font-weight: 600;">ì›ë³¸ ë¬¸ì œ</div>
                                    <div style="font-size: 0.9rem; color: #636e72;">${q.originalQuestion || '(ì—†ìŒ)'}</div>
                                </div>
                                <div style="padding: 12px 15px; background: #fffbeb; border-radius: 10px; border-left: 3px solid #f39c12;">
                                    <div style="font-size: 0.8rem; color: #f39c12; margin-bottom: 5px; font-weight: 600;">ë³€í˜• ë¬¸ì œ</div>
                                    <div style="font-size: 0.9rem; color: #2d3436;">${q.question || '(ì—†ìŒ)'}</div>
                                </div>
                            </div>
                        `;
                    }
                    
                    // ì„ ì§€ ë¹„êµ (í•­ìƒ í‘œì‹œ)
                    let choicesComparison = '';
                    if (q.originalChoices && q.originalChoices.length > 0) {
                        choicesComparison = `
                            <div style="margin-bottom: 20px; padding: 15px; background: #f0fff4; border-radius: 12px; border: 1px solid #d5f5e3;">
                                <div style="font-size: 0.9rem; font-weight: 600; color: #00b894; margin-bottom: 12px;">ğŸ“Š ì„ ì§€ ë¹„êµ</div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                    <div style="font-size: 0.8rem; color: #b2bec3; font-weight: 600; padding-bottom: 8px; border-bottom: 1px solid #e8f5e9;">ì›ë³¸ ì„ ì§€</div>
                                    <div style="font-size: 0.8rem; color: #f39c12; font-weight: 600; padding-bottom: 8px; border-bottom: 1px solid #ffeaa7;">ë³€í˜• ì„ ì§€</div>
                                    ${q.originalChoices.map((oc, i) => `
                                        <div style="font-size: 0.85rem; color: #636e72; padding: 8px 0; ${i < q.originalChoices.length - 1 ? 'border-bottom: 1px solid #f0f0f0;' : ''}">${['â‘ ','â‘¡','â‘¢','â‘£','â‘¤'][i]} ${oc}</div>
                                        <div style="font-size: 0.85rem; color: #2d3436; padding: 8px 0; ${i < q.choices.length - 1 ? 'border-bottom: 1px solid #ffeaa7;' : ''}">${['â‘ ','â‘¡','â‘¢','â‘£','â‘¤'][i]} ${q.choices[i] || ''}</div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }
                    
                    comparisonSection = `
                        ${questionComparison}
                        ${choicesComparison}
                        ${q.changes ? `
                            <div style="margin-bottom: 15px; padding: 12px 15px; background: #fffbeb; border-radius: 10px; font-size: 0.85rem; border-left: 3px solid #f39c12;">
                                <strong style="color: #f39c12;">ğŸ“ ë³€ê²½ ì‚¬í•­:</strong> <span style="color: #636e72;">${q.changes}</span>
                            </div>
                        ` : ''}
                    `;
                }
                
                // Aìœ í˜•: ë¬¸ì œë§Œ í‘œì‹œ
                let questionSection = '';
                if (q.level !== 'B') {
                    questionSection = `
                        ${q.question ? `<div class="question-text"><strong style="color: #2ecc71;">Q.</strong> ${q.question}</div>` : ''}
                    `;
                }
                
                questionCard.innerHTML = `
                    <div class="question-header">
                        <span class="question-number">Q${q.num}</span>
                        <span class="question-level level-${q.level.toLowerCase()}">${q.level}</span>
                    </div>
                    <div style="margin-bottom: 10px;">${levelDescription}</div>
                    <div class="question-instruction">${q.instruction}</div>
                    ${q.level === 'B' ? comparisonSection : questionSection}
                    <div class="question-choices">
                        ${q.choices.map((c, i) => {
                            const isCorrect = (i + 1).toString() === q.answer;
                            return `
                                <div class="choice-item" style="${isCorrect ? 'border: 2px solid #00b894; background: #e8f8f5;' : ''}">
                                    <span class="choice-number">${['â‘ ','â‘¡','â‘¢','â‘£','â‘¤'][i]}</span> ${c}
                                    ${isCorrect ? '<span style="margin-left: 10px; color: #00b894; font-weight: 600;">âœ“ ì •ë‹µ</span>' : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <div class="answer-section" style="margin-top: 15px;">
                        <div class="answer-label">ğŸ“Œ ì •ë‹µ: ${q.answer}ë²ˆ - ${q.choices[parseInt(q.answer) - 1] || ''}</div>
                    </div>
                    ${q.explanation ? `
                        <div class="explanation-section show">
                            <div class="explanation-title">ğŸ“š í•´ì„/í•´ì„¤/ì¶œì œì˜ë„</div>
                            <div class="explanation-content">
                                <div class="explanation-item">
                                    <div class="explanation-label">ğŸ“– í•´ì„</div>
                                    <div>${q.explanation.translation}</div>
                                </div>
                                <div class="explanation-item">
                                    <div class="explanation-label">ğŸ’¡ í•´ì„¤</div>
                                    <div>${q.explanation.explanation}</div>
                                </div>
                                <div class="explanation-item">
                                    <div class="explanation-label">ğŸ¯ ì¶œì œì˜ë„</div>
                                    <div>${q.explanation.intent}</div>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                `;
                questionList.appendChild(questionCard);
                
                // ì •ë‹µ ì¹´ë“œ
                const answerCard = document.createElement('div');
                answerCard.className = 'question-card';
                answerCard.innerHTML = `
                    <div class="question-header">
                        <span class="question-number">Q${q.num}</span>
                        <span class="question-level level-${q.level.toLowerCase()}">${q.level}</span>
                    </div>
                    ${q.question ? `<div style="margin-bottom: 10px; color: #636e72; font-size: 0.9rem;"><strong>ë¬¸ì œ:</strong> ${q.question}</div>` : ''}
                    <div class="answer-section">
                        <div class="answer-label">ì •ë‹µ: ${q.answer}</div>
                    </div>
                    ${q.explanation ? `
                        <div style="margin-top: 15px;">
                            <div class="explanation-item">
                                <div class="explanation-label" style="color: #0984e3;">ğŸ’¡ í•´ì„¤</div>
                                <div style="font-size: 0.9rem; color: #636e72;">${q.explanation.explanation}</div>
                            </div>
                        </div>
                    ` : ''}
                    <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 10px; border: 1px solid #e8f5e9;">
                        <strong style="color: #636e72;">ì›ë¬¸:</strong><br>
                        <span style="font-size: 0.85rem; line-height: 1.6; color: #95a5a6;">${q.originalPassage}</span>
                    </div>
                `;
                answerList.appendChild(answerCard);
            });
            
            // í†µê³„ ì—…ë°ì´íŠ¸
            document.getElementById('totalCount').textContent = generatedQuestions.length;
            document.getElementById('aCount').textContent = counts.A;
            document.getElementById('bCount').textContent = counts.B;
            
            // UI í‘œì‹œ
            resultStats.style.display = 'flex';
            tabsContainer.style.display = 'flex';
            questionList.style.display = 'flex';
            downloadBtn.style.display = 'block';
            explanationBtn.style.display = 'block';
            
            // íƒ­ ì´ë²¤íŠ¸
            document.querySelectorAll('.tab').forEach(tab => {
                tab.onclick = () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    if (tab.dataset.tab === 'questions') {
                        questionList.style.display = 'flex';
                        answerList.style.display = 'none';
                    } else {
                        questionList.style.display = 'none';
                        answerList.style.display = 'flex';
                    }
                };
            });
        }

        // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
        downloadBtn.addEventListener('click', downloadExcel);

        function downloadExcel() {
            const wsData = [
                ['ë¬¸ì œë²ˆí˜¸', 'ë ˆë²¨', 'ë³€í˜•ì„¤ëª…', 'ì§€ì‹œë¬¸', 'ë¬¸ì œ', 'ì„ ì§€1', 'ì„ ì§€2', 'ì„ ì§€3', 'ì„ ì§€4', 'ì„ ì§€5', 'ì •ë‹µ', 'ë³€ê²½ì‚¬í•­', 'í•´ì„', 'í•´ì„¤', 'ì¶œì œì˜ë„', 'ì›ë³¸ë¬¸ì œ', 'ì›ë³¸ì„ ì§€']
            ];
            
            generatedQuestions.forEach(q => {
                let levelDesc = '';
                if (q.level === 'A') levelDesc = 'ì„ ì§€ ìˆœì„œë§Œ ë³€ê²½';
                else if (q.level === 'B') levelDesc = 'ì¼ë¶€ í‘œí˜„ ë³€í˜•';
                
                wsData.push([
                    q.num,
                    q.level,
                    levelDesc,
                    q.instruction,
                    q.question || '',
                    q.choices[0] || '',
                    q.choices[1] || '',
                    q.choices[2] || '',
                    q.choices[3] || '',
                    q.choices[4] || '',
                    q.answer,
                    q.changes || '',
                    q.explanation ? q.explanation.translation : '',
                    q.explanation ? q.explanation.explanation : '',
                    q.explanation ? q.explanation.intent : '',
                    q.originalQuestion || '',
                    q.originalChoices ? q.originalChoices.join(' / ') : ''
                ]);
            });
            
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'ë³€í˜•ë¬¸ì œ');
            
            // ì—´ ë„ˆë¹„ ì„¤ì •
            ws['!cols'] = [
                { wch: 10 }, { wch: 8 }, { wch: 18 }, { wch: 30 }, { wch: 40 },
                { wch: 25 }, { wch: 25 }, { wch: 25 }, { wch: 25 }, { wch: 25 },
                { wch: 10 }, { wch: 30 }, { wch: 50 }, { wch: 50 }, { wch: 40 }, { wch: 40 }, { wch: 60 }
            ];
            
            const now = new Date();
            const dateStr = `${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}_${now.getHours().toString().padStart(2,'0')}${now.getMinutes().toString().padStart(2,'0')}`;
            XLSX.writeFile(wb, `AIë³€í˜•ë¬¸ì œ_${dateStr}.xlsx`);
            
            showToast('ì—‘ì…€ íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        }
    </script>
</body>
</html>
